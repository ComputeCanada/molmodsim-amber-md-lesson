---
title: "Preparing a Protein-Membrane Simulation System"
teaching: 30
exercises: 5
questions:
- "How to prepare a membrane simulation system?"
- "How to pack a protein in a lipid bilayer?"
objectives:
- "Learn how to prepare a membrane simulation system?"
- "Learns to pack a protein in a lipid bilayer?"
keypoints:
- " "
---

### Lipid force field
Amber currently includes Lipid21 as its main membrane force field.  In this modular force field, lipids are modeled as polymers composed of a headgroup and acyl tails. Essentially, this means that each headgroup and tail are independent modules, analogous to protein residues. Each lipid molecule is composed of a tail analogous to an "N-terminal", a central headgroup and another tail analogous to a "C-terminal". You can combine any headgroup with any pair of tails in this force field. Ok, now you should have an idea how the lipids are represented in the Lipid21 force field, and what lipids you can include in a simulation. 

- There is a great deal of information provided in [Dickson, 2022](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9007451/) regarding best practices when using AMBER for lipid simulations.
- Full list of supported lipids is in Section 3.4 of [Amber22 manual](https://ambermd.org/doc12/Amber22.pdf)

Known Issues: 
Using MC barostat with hard LJ cutoff is known to cause bilayer deformation. It is recommended to use an LJ force switch when running simulations with the MC barostat.[Gomez, 2021](https://onlinelibrary.wiley.com/doi/abs/10.1002/jcc.26798)

### Creating simulation systems with packmol-memgen
- What lipids are available?

~~~
ml StdEnv/2020 gcc cuda/11.4 ambertools/22
packmol-memgen --available_lipids 
~~~
{: .language-bash}

- To see all available lipids use  `--available_lipids_all`, but the list will have thousands of items!

#### Creating a membrane-only simulation system
Submission script for creating a membrane-only simulation system:
~~~
#!/bin/bash
#SBATCH -c1 --mem-per-cpu=2000 --time=3:0:0

module purge
module load StdEnv/2020 gcc cuda/11.4 ambertools/22
packmol-memgen \
    --lipids DOPE:DOPG \
    --ratio 3:1 \
    --distxy_fix 100 \
    --parametrize
~~~
{: .language-bash}

- if the option --parametrize is given the solvated system is bilayer_only_lipid.pdb
- without --parametrize the solvated system is  bilayer_only.pdb
- Multiple bilayers can be generated by repeating corresponding flags.
- Bilayers with different leaflet composition can be generated:
--lipids CHL1:POPC:POPE:PSM//CHL1:POPC:POPE:PSM:POPS:POPI:POGL --ratio 4:4:2:1//6:2:3:2:2:2:2  



This example illustrates the building of a bilayer where leaflets consist of different types of lipids:
~~~
#!/bin/bash
#SBATCH -c1 --mem-per-cpu=4000 --time=6:0:0

module purge
module load StdEnv/2020 gcc/9.3.0 openmpi/4.0.3 ambertools/23

rm -f bilayer* *.log
packmol-memgen \
    --lipids CHL1:POPC:POPE:PSM//CHL1:POPC:POPE:PSM \
    --salt --salt_c Na+ --salt_a Cl- --saltcon 0.15 \
    --dist_wat 15 \
    --ratio 4:3:1:2//4:3:1:2 \
    --distxy_fix 100 \
    --parametrize
~~~
{: .language-bash}

This generates bilayer_only_lipids.pdb which can be used to create topology files with AMBER force fields not available in packmol-memgen. Example using OPC3-Pol polarizable water:

~~~
leap_input=$(cat << EOF
source leaprc.water.opc3pol
source leaprc.lipid21 
sys=loadpdb bilayer_only_lipid.pdb
set sys box {111.3 111.3 81.5}
saveamberparm sys bilayer.parm7 bilayer.rst7
quit
EOF)
tleap -f <(echo "$leap_input")
~~~
{: .language-bash}

Box size can be extracted from the file bilayer_only_lipid.top:

~~~
grep -A2 BOX bilayer_only_lipid.top
~~~
{: .language-bash}


### Simulating a packed membrane system.

#### Energy minimization
Minimization input file (minimization.in).
~~~
Minimization
 &cntrl
  imin=1,       ! Minimization 
  ntmin=3,      ! Steepest Descent 
  maxcyc=1000,  ! Maximum number of cycles for minimization
  ntpr=10,      ! Print to mdout every ntpr steps        
  ntwr=1000,    ! Write a restart file every ntwr steps
  cut=10.0,     ! Nonbonded cutoff
 /
 ~~~
 {: .file-content}

 Submission script
 ~~~
 #!/bin/bash
#SBATCH --mem-per-cpu=4000 --ntasks=10 --time=6:0:0 

module purge
module load StdEnv/2020  gcc/9.3.0  cuda/11.4  openmpi/4.0.3 amber/20.12-20.15

srun sander.MPI -O -i min.in \
-o minimization.out \
-p ../bilayer.parm7 \
-c ../bilayer.rst7 \
-r minimized.rst7 
 ~~~
{: .language-bash}

#### Heating
~~~
Heating 
 &cntrl
  imin=0,         	! Molecular dynamics
  ntx=1,          	! Read coordinates with no initial velocities
  ntc=2,          	! SHAKE on for bonds with hydrogen
  ntf=2,         	! No force evaluation for bonds with hydrogen
  tol=0.0000001,  	! SHAKE tolerance
  nstlim=20000,   	! Number of MD steps
  ntt=1,          	! Berendsen thermostat
  tempi=100,       	! Initial temperature
  temp0=300,        ! Target temperature
  tautp=5.0,        ! Time constant for heat bath coupling
  ntpr=100,         ! Write energy info every ntwr steps 
  ntwr=10000,       ! Write restart file every ntwr steps
  ntwx=2000,      	! Write to trajectory file every ntwx steps
  dt=0.001,       	! Timestep 
  ntb=2,            ! Constant pressure periodic bc.
  barostat=1,       ! Berendsen barostat
  taup=5,           ! Pressure relaxation time
  ntp=3,            ! Semiisotropic pressure scaling
  csurften=3,       ! Constant surface tension with interfaces in the xy plane
  cut=10.0,         ! Nonbonded cutoff
 /
~~~
{: .file-content}

Submission script
~~~
#!/bin/bash
#SBATCH --mem-per-cpu=4000 --gpus-per-node=v100:1 --time=6:0:0 

module purge
module load StdEnv/2020  gcc/9.3.0  cuda/11.4  openmpi/4.0.3 amber/20.12-20.15

pmemd.cuda -O -i heating.in \
-o heating.out \
-p ../bilayer.parm7 \
-c minimized.rst7 \
-r heated.rst7 \
~~~
{: .language-bash}

#### Equilibration - phase 1
~~~
Equilibration 1 
 &cntrl
  imin=0,         	! Molecular dynamics
  irest=1,          ! Restart
  ntx=5,          	! Read positions and velocities
  ntc=2,          	! SHAKE on for bonds with hydrogen
  ntf=2,         	! No force evaluation for bonds with hydrogen
  tol=0.0000001,  	! SHAKE tolerance
  nstlim=100000,   	! Number of MD steps
  ntt=1,          	! Berendsen thermostat
  temp0=300,        ! Set temperature
  tautp=5.0,        ! Time constant for heat bath coupling
  ntpr=100,         ! Write energy info every ntwr steps 
  ntwr=10000,       ! Write restart file every ntwr steps
  ntwx=2000,      	! Write to trajectory file every ntwx steps
  dt=0.001,       	! Timestep (ps)
  ntb=2,            ! Constant pressure periodic bc.
  barostat=1,       ! Berendsen barostat
  taup=5,           ! Pressure relaxation time
  ntp=3,            ! Semiisotropic pressure scaling
  csurften=3,       ! Constant surface tension with interfaces in the xy plane
  cut=10.0,         ! Nonbonded cutoff 
 /
~~~
{: .file-content}

Submission script
~~~
#!/bin/bash
#SBATCH --mem-per-cpu=4000 --gpus-per-node=v100:1 --time=6:0:0 

module purge
module load StdEnv/2020  gcc/9.3.0  cuda/11.4  openmpi/4.0.3 amber/20.12-20.15

pmemd.cuda -O -i equilibration.in \
-o eq-1.out \
-p ../bilayer.parm7 \
-c heated.rst7 \
-r eq-1.rst7 \
~~~
{: .language-bash}

#### Equilibration - phase 2
~~~
Equilibration 2 
 &cntrl
  imin=0,         	! Molecular dynamics
  irest=1           ! Restart
  ntx=5,            ! Read  positions and  velocities
  ntc=2,          	! SHAKE on for bonds with hydrogen
  ntf=2,         	! No force evaluation for bonds with hydrogen
  tol=0.0000001,  	! SHAKE tolerance
  nstlim=2500000,   ! Number of MD steps
  ntt=3,            ! Langevin thermostat 
  temp0=300,        ! Target temperature
  gamma_ln=2.0,     ! Collision frquency 
  ntpr=100,         ! Write energy info every ntwr steps 
  ntwr=10000,       ! Write restart file every ntwr steps
  ntwx=10000,      	! Write to trajectory file every ntwx steps
  dt=0.002,       	! Timestep (ps)
  ntb=2,            ! Constant pressure periodic bc.
  barostat=1,       ! Berendsen barostat
  taup=1.0,         ! Pressure relaxation time
  ntp=3,            ! Semiisotropic pressure scaling
  csurften=3,       ! Constant surface tension with interfaces in the xy plane
  cut=10.0,         ! Nonbonded cutoff 
 /
~~~
{: .file-content}

Submission script
~~~
#!/bin/bash
#SBATCH --mem-per-cpu=4000 --gpus-per-node=v100:1 --time=6:0:0 

module purge
module load StdEnv/2020  gcc/9.3.0  cuda/11.4  openmpi/4.0.3 amber/20.12-20.15

pmemd.cuda -O -i equilibration-2.in \
-o eq-2.out \
-p ../bilayer.parm7 \
-c eq-1.rst7 \
-r eq-2.rst7 \
~~~
{: .language-bash}

AMBER offers only two barostats:  Monte Carlo and Berendsen. As it was found that Monte Carlo barostat results in the depression of areas per lipid, it is not recommended for lipid bilayer simulations with AMBER  [[Lipid21: Complex Lipid Membrane Simulations with AMBER]](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9007451/). Berendsen barostat does not strictly sample from the isothermal-isobaric ensemble and typically yields volume fluctuations that are too low. 
If you need correct thermodynamocs ensemble you can continue simulating this system in another MD package that offers more pressure coupling algorithms. In the next section we will demonstrate transferring equilibrated MD system from AMBER to GROMACS

#### Moving to GROMACS

- Change directory to 4-equilibration.
- Create a directory for GROMACS simulation
- Load ambertools and gromacs modules and start python

~~~
mkdir ../5-amb2gro 
cp eq-2.rst7 ../5-amb2gro 
cd ../5-amb2gro
ln -s ../bilayer.parm7 bilayer.parm7 
module load StdEnv/2020 gcc/9.3.0 cuda/11.4 openmpi/4.0.3 ambertools/23 gromacs/2023.2
python
~~~
{: .language-bash}


#### Converting amber restart and topology to gromacs.
Use parmed AMBER utility to convert AMBER topology and restart files to GROMACS.

~~~
import parmed as pmd
amber = pmd.load_file("bilayer.parm7", "eq-2.rst7")
ncrest=pmd.amber.Rst7("eq-2.rst7")
amber.velocities=ncrest.vels
amber.save("restart.gro")
amber.save("bilayer.top")
quit()
~~~
{: .language-python}

These parmed commands will create two GROMACS files: restart.gro and bilayer.top

#### Creating and editing index file
Next we create and edit index file.
~~~
gmx make_ndx -f restart.gro << EOF
del 12 
del 12
1&!rNa+&!rCl- 
name 12 Lipids
11|rNa+|rCl- 
name 13 WaterIons   
q
EOF
~~~
{: .language-bash}

Check created index file:
~~~
gmx make_ndx -f restart.gro -n index.ndx
~~~
{: .language-bash}

You should have two new groups:  
12 Lipids              : 53850 atoms 
13 WaterIons           : 66792 atoms 

#### Creating GROMACS restart file

Gromacs simulation input file

tcoupl              = nose-hoover
tau-t               = 1
tc-grps             = 11 12
pcoupl              = Parrinello-Rahman
pcoupltype          = semiisotropic
tau-p               = 5  5
compressibility     = 4.5e–5 4.5e–5


~~~
Title                   = bilayer
; Run parameters
integrator              = md
nsteps                  = 400000
dt                      = 0.001
; Output control
nstxout                 = 0
nstvout                 = 0
nstfout                 = 0
nstenergy               = 100
nstlog                  = 10000
nstxout-compressed      = 5000
compressed-x-grps       = System
; Bond parameters
continuation            = yes
constraint_algorithm    = lincs
constraints             = h-bonds
; Neighborsearching
cutoff-scheme           = Verlet
ns_type                 = grid
nstlist                 = 10
rcoulomb                = 1.0
rvdw                    = 1.0
DispCorr                = Ener ; anaytic VDW correction
; Electrostatics
coulombtype             = PME
pme_order               = 4
; Temperature coupling is on
tcoupl                  = V-rescale
tc-grps                 = WaterIons Lipids
tau_t                   = 0.1 0.1
ref_t                   = 300 300
; Pressure coupling is on
pcoupl                  = Parrinello-Rahman
pcoupltype              = semiisotropic
tau_p                   = 5.0
ref_p                   = 1.0 1.0
compressibility         = 4.5e-5 4.5e-5
; Periodic boundary conditions
pbc                     = xyz
; Velocity generation
gen_vel                 = no
~~~

~~~
gmx trjconv -f restart.gro -o restart.trr
gmx grompp -p bilayer.top  -c restart.gro -t restart.trr -f production.mdp -maxwarn 1
~~~
{: .language-bash}

#### Running simulation
~~~
#!/bin/bash
#SBATCH  --mem-per-cpu 4000 --time 1:0:0   
#SBATCH  -c10 --gpus-per-node=v100:1
  
module load StdEnv/2020 gcc/9.3.0 cuda/11.4 openmpi/4.0.3 gromacs/2023.2

srun gmx mdrun -ntomp ${SLURM_CPUS_PER_TASK:-1} \
-nb gpu -pme gpu -update gpu -bonded cpu -s topol.tpr
~~~
{: .language-bash}


### Embedding a protein into a bilayer
We will use PDB file 6U9P (wild-type MthK pore in ~150 mM K+) for this exercise.

1. Use [PPM server](https://opm.phar.umich.edu/ppm_server) to orient a protein. PPM server will also take care of assembling the complete tetrameric pore.
2. Use vmd to remove ligands and conformers B.

~~~
module load StdEnv/2020 vmd
vmd
~~~
{: .language-bash}

~~~
mol new 6u9pout.pdb
set sel [atomselect top "protein and not altloc B"]
$sel writepdb 6U9P-clean.pdb
quit
~~~
{: .vmd}

3. Submission script to embed a protein into a lipid bilayer

 ~~~
 #!/bin/bash
 #SBATCH -c1 --mem-per-cpu=2000 --time=1:0:0
 
 module purge
 module load StdEnv/2020 gcc cuda/11.4 ambertools/22
 packmol-memgen \
	--pdb 6U9P-clean.pdb \ 
	--lipids DOPE:DOPG \
	--ratio 3:1 \
    --preoriented 
 ~~~
 {: .language-bash}

- Use `--parametrize` to make simulation input files. The default protein force field is FF14SB, water model TIP3P. 
- To use a different force field:
`--fprot ff19SB --ffwat opc --gaff2`
- To add salt (default K+, 0.15M): 
`--salt`


### Preparing ligands 

- Download hexanediol HEZ.cif: wget https://www.rcsb.org/ligand/HEZ
- Convert .cif to .pdb: https://mmcif.pdbj.org/converter/index.php?l=en

1. Make mol2 file with antechamber:

~~~
 module load StdEnv/2020 gcc cuda/11.4 ambertools/22
 antechamber -i HEZ.pdb -fi pdb -o HEZ.mol2 -fo mol2 -c bcc -s 2
~~~
{: .language-bash}

The file HEZ.mol2 contains the definition of our HEZ residue including connectivity, all of the charges and atom types. 

2. Run parmchk2 to find out if there are any missing force field parameters:

~~~
 parmchk2 -i HEZ.mol2 -f mol2 -o HEZ.frcmod
~~~
{: .language-bash}

If it can antechamber will fill in these missing parameters by analogy to a similar parameter.

3. Create the library file for HEZ using tleap:

~~~
source leaprc.gaff2
HEZ=loadmol2 HEZ.mol2
check HEZ
saveoff HEZ hez.lib 
~~~
{: .leap}

Of course point charges are not very accurate because they are derived using semi-empirical method, but antechamber can also use results of gaussian QM calculations.  

### Links to advanced AMBER tutorials
- [Placing waters and ions using 3D-RISM and MOFT](http://ambermd.org/tutorials/advanced/tutorial34/index.html)
- [Building a Membrane System with PACKMOL-Memgen](https://ambermd.org/tutorials/advanced/tutorial38/index.php#Lipid_System)
- [Minimizing and Equilibrating a packed membrane system](https://ambermd.org/tutorials/advanced/tutorial38/equi_input.php)
- [Setup and simulation of a membrane protein with AMBER Lipid21 and PACKMOL-Memgen](https://github.com/callumjd/AMBER-Membrane_protein_tutorial). 